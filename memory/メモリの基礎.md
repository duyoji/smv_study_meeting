# メモリの基礎



メモリを気にしてプログラム書いて品質の高いプログラマになろう!




## メモリ領域
- 主に4つ
	- プログラム本体 : text         LOW
	- グローバル変数 : data
	- malloc, new    : heap
	- ローカル変数   : stack        HIGH

**必要な時に必要なだけのメモリを確保する方法として、C言語では標準関数で malloc()が用意されている**

**スタックとは別の仕組みが必要です。そのために用意されているメモリ領域のことを「ヒープ領域」**

- stack呼び出しが終わったら消える
- 呼び出しが終わっても消えないものをつくるためにはstackとは別の領域が必要 => heap


## 倫理アドレス,ページング

例えばあるアプリケーションで4kB使うメモリの場合、4kB分の論理アドレスは物理メモリ4kB分埋める
⬇
これが続くとメモリがうまる。
⬇
埋まった状態でさらにメモリを使おうとするとしばらく使っていないものからスワップ(ハードディスク)に逃がして
新しいものにメモリを割り当てる


32bitコンピユータは4GB弱 使えるアドレス空間が64bitと比べて少ない



## inside malloc

ページサイズの倍数4KB

malloc(100)
⬇
100b/4KB

実際は4KBのなかで100bだけではなくmallocしたアドレスがどこにあるか指し示せるポインタ情報も保持しているため100b(malloc)+ポインタ情報(ちょっとバイト)=100+xバイト

mallocはfreeで確保した領域が開放されるが開放されたところはメモリがあく

あとからmallocするばあいfreeして空いたところに入るようであればそこに入り、入らなければ大きいエリアにいく

空き領域がどれくらい空いているか管理するリストを保持して、すばやく新しくmallocしたものが入れるところを探す

⬇
空いているところを見つけてメモリを確保指定上げるのがmallocの仕事
連結リストを作る

**K&R malloc**
http://www.serendip.ws/archives/4575


**dl malloc**が有名
Linux,DalvicVM


## メモリの断片化

空きメモりを全部足したら足りるとしても、一番空いているメモリ空間より大きい値をmallocをすると確保できない

- 空き領域の管理は連結リスト

**メモリの断片化**が増えると起こる問題

- メモリ確保に時間がかかる( 古いものをswapに移動させたりするなどどうにかしてメモリを空けるようにするから)


## GC(ガベージコレクション)

- 参照カウント
  - http://d.hatena.ne.jp/moriyoshi/20080528/1211955227
- マーク&スイープ
- 世代別GC
- コンカレントGC 
  - http://www.atmarkit.co.jp/fjava/rensai4/troublehacks02/troublehacks02_1.html

- GCとコンパクションの説明
    - http://okwave.jp/qa/q1135542.html

- オートボクシング
  - http://nextindex.s141.xrea.com/java/boxing.html
